@model CartifyBLL.ViewModels.Checkout.CheckoutVm
@{
    ViewData["Title"] = "Checkout";
}

<div class="container py-5">
    <h2 class="mb-4">Checkout</h2>

    <form id="checkoutForm" asp-action="ProcessOrder" asp-controller="Checkout" method="post" novalidate>
        @Html.AntiForgeryToken()

        <div class="row">
            <!-- LEFT COLUMN -->
            <div class="col-md-8">

                <!-- SHIPPING ADDRESS -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Shipping Address</h5>
                        <a href="https://localhost:7293/Account/Profile?#address" class="btn btn-sm btn-outline-primary">
                            Manage Addresses
                        </a>
                    </div>
                    <div class="card-body">
                        @if (Model.UserAddresses?.Any() == true)
                        {
                            @foreach (var address in Model.UserAddresses)
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="SelectedAddressId"
                                           value="@address.Id" @(Model.SelectedAddressId == address.Id ? "checked" : null) required>
                                    <label class="form-check-label">
                                        @address.StreetAddress, @address.City, @address.State, @address.Country - @address.PostalCode
                                        @if (address.IsDefault)
                                        {
                                            <span class="badge bg-success ms-2">Default</span>
                                        }
                                    </label>
                                </div>
                            }
                            <span asp-validation-for="SelectedAddressId" class="text-danger"></span>
                        }
                        else
                        {
                            <p class="text-muted">No saved addresses. Please add one in your profile.</p>
                        }
                    </div>
                </div>

                <!-- PAYMENT METHOD -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5>Payment Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <select asp-for="PaymentMethod" id="PaymentMethod" class="form-select" required>
                                <option value="">-- Choose Payment Method --</option>
                                <option value="CreditCard">Credit Card</option>
                                <option value="PayPal">PayPal</option>
                                <option value="COD">Cash on Delivery</option>
                            </select>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>

                        <!-- CREDIT CARD FIELDS -->
                        <div id="creditCardFields" style="display:none;">
                            <div class="mb-3">
                                <label asp-for="CardNumber" class="form-label">Card Number</label>
                                <input asp-for="CardNumber" class="form-control" placeholder="XXXX-XXXX-XXXX-XXXX" maxlength="19" />
                                <span asp-validation-for="CardNumber" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="CardHolderName" class="form-label">Cardholder Name</label>
                                <input asp-for="CardHolderName" class="form-control" placeholder="Full name as on card" />
                                <span asp-validation-for="CardHolderName" class="text-danger"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label asp-for="ExpiryMonth" class="form-label">Expiry Month</label>
                                    <input asp-for="ExpiryMonth" class="form-control" placeholder="MM" maxlength="2" />
                                    <span asp-validation-for="ExpiryMonth" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="ExpiryYear" class="form-label">Expiry Year</label>
                                    <input asp-for="ExpiryYear" class="form-control" placeholder="YYYY" maxlength="4" />
                                    <span asp-validation-for="ExpiryYear" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="CVV" class="form-label">
                                        CVV
                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="3-digit code on back of your card"></i>
                                    </label>
                                    <input asp-for="CVV" class="form-control" placeholder="XXX" maxlength="4" />
                                    <span asp-validation-for="CVV" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- PAYPAL FIELDS -->
                        <div id="paypalFields" style="display:none;">
                            <div class="mb-3">
                                <label for="PaypalLink" class="form-label">PayPal Email or Link</label>
                                <input type="email" class="form-control" id="PaypalLink" name="PaypalLink" placeholder="your-email@example.com" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @foreach (var item in Model.Cart.Items)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@item.ProductName</strong><br />
                                        <small>Qty: @item.Quantity</small>
                                    </div>
                                    <span>@item.TotalPrice.ToString("C")</span>
                                </li>
                            }
                        </ul>

                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>Subtotal</span>
                            <strong>@Model.SubTotal.ToString("C")</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Tax</span>
                            <strong>@Model.Tax.ToString("C")</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Shipping</span>
                            <strong>@Model.ShippingCost.ToString("C")</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total</strong>
                            <strong>@Model.Total.ToString("C")</strong>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-4">Place Order</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const paymentSelect = document.getElementById("PaymentMethod");
        const creditCardFields = document.getElementById("creditCardFields");
        const paypalFields = document.getElementById("paypalFields");

        paymentSelect.addEventListener("change", function () {
            creditCardFields.style.display = "none";
            paypalFields.style.display = "none";
            if (this.value === "CreditCard") {
                creditCardFields.style.display = "block";
            } else if (this.value === "PayPal") {
                paypalFields.style.display = "block";
            }
        });

        document.getElementById("checkoutForm").addEventListener("submit", function (e) {
            if (paymentSelect.value === "CreditCard") {
                const cardNumber = document.getElementById("CardNumber").value.replace(/\D/g, "");
                if (cardNumber.length !== 16) {
                    e.preventDefault();
                    alert("Card number must be exactly 16 digits.");
                }
                const expiryYear = document.getElementById("ExpiryYear").value.trim();
                if (!/^\d{4}$/.test(expiryYear)) {
                    e.preventDefault();
                    alert("Please enter a valid 4-digit expiry year.");
                }
            } else if (paymentSelect.value === "PayPal") {
                const paypalLink = document.getElementById("PaypalLink").value.trim();
                if (!paypalLink) {
                    e.preventDefault();
                    alert("Please enter your PayPal email or link.");
                }
            }
        });

        // Bootstrap tooltips
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el);
        });
    </script>
}
