@model CartifyBLL.ViewModels.Checkout.CheckoutVm
@{
    ViewData["Title"] = "Checkout";
}

<div class="container py-5">
    <h2 class="mb-4">Checkout</h2>

    <form id="checkoutForm" asp-action="ProcessOrder" asp-controller="Checkout" method="post">
        @Html.AntiForgeryToken()

        <div class="row">
            <!-- Left Column: Address + Payment -->
            <div class="col-md-8">

                <!-- Shipping Address -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Shipping Address</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.UserAddresses != null && Model.UserAddresses.Any())
                        {
                            <div class="mb-3">
                                <label asp-for="SelectedAddressId" class="form-label">Select an Address</label>
                                @foreach (var address in Model.UserAddresses)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="radio"
                                               name="SelectedAddressId"
                                               value="@address.Id"
                                               @(Model.SelectedAddressId == address.Id ? "checked" : null) />
                                        <label class="form-check-label">
                                            @address.StreetAddress, @address.City, @address.State, @address.Country - @address.PostalCode
                                            @if (address.IsDefault)
                                            {
                                                <span class="badge bg-success ms-2">Default</span>
                                            }
                                        </label>
                                    </div>
                                }
                                <span asp-validation-for="SelectedAddressId" class="text-danger"></span>
                            </div>
                        }

                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" asp-for="UseNewAddress" id="useNewAddress" />
                            <label class="form-check-label" for="useNewAddress">Use New Address</label>
                        </div>

                        <div id="newAddressFields" class="mt-3" style="display:none;">
                            <div class="mb-3">
                                <label asp-for="NewAddress.StreetAddress" class="form-label"></label>
                                <input asp-for="NewAddress.StreetAddress" class="form-control" />
                                <span asp-validation-for="NewAddress.StreetAddress" class="text-danger"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="NewAddress.City" class="form-label"></label>
                                    <input asp-for="NewAddress.City" class="form-control" />
                                    <span asp-validation-for="NewAddress.City" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="NewAddress.State" class="form-label"></label>
                                    <input asp-for="NewAddress.State" class="form-control" />
                                    <span asp-validation-for="NewAddress.State" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="NewAddress.PostalCode" class="form-label"></label>
                                    <input asp-for="NewAddress.PostalCode" class="form-control" />
                                    <span asp-validation-for="NewAddress.PostalCode" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="NewAddress.Country" class="form-label"></label>
                                    <input asp-for="NewAddress.Country" class="form-control" />
                                    <span asp-validation-for="NewAddress.Country" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Payment Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="PaymentMethod" class="form-label"></label>
                            <select asp-for="PaymentMethod" class="form-select">
                                <option value="CreditCard">Credit Card</option>
                                <option value="PayPal">PayPal</option>
                                <option value="COD">Cash on Delivery</option>
                            </select>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>

                        <!-- Credit Card Fields -->
                        <div id="creditCardFields">
                            <div class="mb-3">
                                <label asp-for="CardNumber" class="form-label"></label>
                                <input asp-for="CardNumber" class="form-control" />
                                <span asp-validation-for="CardNumber" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="CardHolderName" class="form-label"></label>
                                <input asp-for="CardHolderName" class="form-control" />
                                <span asp-validation-for="CardHolderName" class="text-danger"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label asp-for="ExpiryMonth" class="form-label"></label>
                                    <input asp-for="ExpiryMonth" class="form-control" />
                                    <span asp-validation-for="ExpiryMonth" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="ExpiryYear" class="form-label"></label>
                                    <input asp-for="ExpiryYear" class="form-control" />
                                    <span asp-validation-for="ExpiryYear" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="CVV" class="form-label"></label>
                                    <input asp-for="CVV" class="form-control" />
                                    <span asp-validation-for="CVV" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column: Order Summary -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @foreach (var item in Model.Cart.Items)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@item.ProductName</strong><br />
                                        <small>Qty: @item.Quantity</small>
                                    </div>
                                    <span>@item.TotalPrice.ToString("C")</span>
                                </li>
                            }
                        </ul>

                        <hr />
                        <div class="d-flex justify-content-between">
                            <span>Subtotal</span>
                            <strong>@Model.SubTotal.ToString("C")</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Tax</span>
                            <strong>@Model.Tax.ToString("C")</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Shipping</span>
                            <strong>@Model.ShippingCost.ToString("C")</strong>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between">
                            <strong>Total</strong>
                            <strong>@Model.Total.ToString("C")</strong>
                        </div>

                        <div class="mt-4">
                            <button type="button" id="place-order" class="btn btn-primary w-100">
                                Place Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.getElementById("useNewAddress")?.addEventListener("change", function () {
            document.getElementById("newAddressFields").style.display = this.checked ? "block" : "none";
        });

        document.getElementById("PaymentMethod")?.addEventListener("change", function () {
            document.getElementById("creditCardFields").style.display = this.value === "CreditCard" ? "block" : "none";
        });
    </script>
    <script src="~/js/pages/checkout.js"></script>
}
